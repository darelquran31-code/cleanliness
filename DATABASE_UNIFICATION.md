# توحيد جداول الفواتير والمواد

## المشكلة الأصلية
كانت البيانات موزعة على جدولين منفصلين:
- **Receipts**: بيانات المسجد والعامل ومسجل البيانات
- **ReceiptDetails**: تفاصيل المواد المستلمة

هذا كان يتطلب دمج البيانات في الـ Backend والـ Frontend.

## الحل الجديد ✅
**جدول موحد واحد: `AllReceipts`**

كل صف يحتوي على:
- بيانات المسجد الكاملة
- بيانات العامل
- بيانات مسجل البيانات
- بيانات المادة الواحدة

### هيكل جدول AllReceipts

| الحقل | الرمز | النوع | الوصف |
|-------|------|-------|-------|
| التاريخ والوقت | A | Text | timestamp للفاتورة |
| الرقم المدني (المسجل) | B | Text | رقم مدني مسجل البيانات |
| اسم المسجل | C | Text | اسم مسجل البيانات |
| المسجد | D | Text | اسم المسجد |
| المحافظة | E | Text | المحافظة |
| المنطقة | F | Text | المنطقة |
| القطعة | G | Text | رقم القطعة |
| اسم العامل | H | Text | اسم عامل التنظيف |
| الرقم المدني للعامل | I | Text | الرقم المدني للعامل |
| رقم هاتف مسجل البيانات | J | Text | رقم الهاتف |
| معرف المادة | K | Number | ID من جدول Materials |
| اسم المادة | L | Text | اسم المادة من جدول Materials |
| الوحدة | M | Text | وحدة القياس (كيس، صندوق، إلخ) |
| الكمية المخصصة | N | Number | الكمية الموحدة من Materials |
| الكمية المستلمة | O | Number | الكمية التي استلمها العامل |

## ملفات تم تعديلها

### 1. **Backend**

#### `/backend/routes/user.js`
- تعديل `POST /api/user/add-receipt`
  - بدلاً من إضافة صف واحد في Receipts و عدة صفوف في ReceiptDetails
  - الآن نضيف عدة صفوف في AllReceipts (صف لكل مادة مع بيانات المسجد)

- تعديل `GET /api/user/receipts`
  - بدلاً من دمج بيانات من جدولين
  - الآن نقرأ من AllReceipts ونجمع الصفوف بناءً على timestamp

#### `/backend/setupUnifiedReceiptsHeaders.js` (ملف جديد)
- ملف لإعداد رؤوس الجدول الموحد
- يمكن تشغيله بـ: `node setupUnifiedReceiptsHeaders.js`

### 2. **Frontend**

#### `/frontend/src/pages/Dashboard.jsx`
- تعديل عرض الفواتير
- كل فاتورة تحتوي على جدول للمواد المستلمة
- عرض البيانات بشكل منظم وواضح

#### `/frontend/src/styles/Dashboard.css`
- إضافة أنماط جديدة:
  - `.receipt-header` - رأس الفاتورة
  - `.receipt-info` - بيانات المسجد والمنطقة
  - `.receipt-worker` - بيانات العامل
  - `.receipt-materials` - جدول المواد
  - `.materials-simple-table` - جدول بسيط للمواد

## الفوائد

✅ **تبسيط البيانات**: جدول واحد بدلاً من جدولين  
✅ **سهولة البحث**: يمكن البحث بسهولة عن كل البيانات في مكان واحد  
✅ **سهولة الفهم**: كل صف يحتوي على معلومة كاملة  
✅ **سهولة التصدير**: يمكن تصدير البيانات مباشرة  
✅ **تقليل التعقيد**: لا حاجة لدمج البيانات في البرنامج  

## خطوات الإعداد

### 1. إعداد رؤوس الجدول الجديد
```bash
node backend/setupUnifiedReceiptsHeaders.js
```

### 2. الحفاظ على البيانات القديمة (اختياري)
إذا كنت تريد الاحتفاظ بالبيانات من Receipts و ReceiptDetails:

```javascript
// يمكن نسخ البيانات القديمة إلى AllReceipts
// باستخدام دالة مساعدة (يمكن إضافتها لاحقاً)
```

### 3. حذف الجداول القديمة (اختياري)
بعد التأكد من أن كل البيانات في AllReceipts:
- يمكن حذف Receipts
- يمكن حذف ReceiptDetails

## الاختبار

### 1. اختبار إضافة فاتورة جديدة
```bash
# تسجيل الدخول بحساب عادي
# إضافة فاتورة جديدة
# التحقق من ظهورها في لوحة المتابعة
```

### 2. التحقق من البيانات
```bash
# فتح Google Sheets
# التحقق من وجود البيانات في AllReceipts
# كل صف يجب أن يحتوي على معلومة كاملة
```

## ملاحظات مهمة

⚠️ **قبل الترقية**: احفظ نسخة احتياطية من بيانات Google Sheets  
⚠️ **اختبر أولاً**: جرب النظام الجديد قبل حذف الجداول القديمة  
⚠️ **التوافقية**: تأكد من أن جميع الأدوات التابعة تدعم الهيكل الجديد  

## الدعم الأساسي للترجوع

إذا واجهت مشاكل:
1. تحقق من أن Google Sheets متصل بشكل صحيح
2. تأكد من أن معرّفات المواد صحيحة (1, 2, 3, ...)
3. راجع logs الـ Backend للأخطاء